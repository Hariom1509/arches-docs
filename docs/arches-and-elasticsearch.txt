########################
Arches and Elasticsearch
########################

Installing and Running Elasticsearch
====================================

The quickest way to install Elasticsearch is to download and unzip one of the `compressed installers 
for the proper version <https://www.elastic.co/downloads/past-releases/elasticsearch-5-6-16>`_.

To start the service from the command line, use

.. code-block:: shell

   path/to/elasticsearch-5.6.16/bin/elasticsearch

To run as a daemon process, add ``-d`` to that command.

On Windows you can just double-click the ``path\to\elasticsearch-5.6.16\bin\elasticsearch.bat``
batch file to run the process in a new console.

----

Another way to install Elasticsearch is to use a command that comes with Arches::

    python manage.py es install

Elasticsearch will be installed in the root folder. You can specify an alternate destination for the installation by using the ``-d`` argument. For example::

    python manage.py es install -d C:\Projects

will result in a new directory ``C:\Projects\elasticsearch-5.2.1`` from which you'll be able to run Elasticsearch as described above.

----

To make sure Elasticsearch is running, use

.. code-block:: bash

    curl localhost:9200

You should get a JSON response that includes "You Know, For Search...". You can also use the Chrome plugin `ElasticSearch Head <https://chrome.google.com/webstore/detail/elasticsearch-head/ffmkiejjmecolpfloofpjologoblkegm?hl=en-US>`_ to view your instance in a browser at ``localhost:9200``.

For more information, please visit the official `Elasticsearch documentation <https://www.elastic.co/guide/en/elasticsearch/guide/current/running-elasticsearch.html>`_.

.. important::
   1. By default, Elasticsearch uses 2GB of memory (RAM). For basic development purposes, we have found it to run well enough on 1GB. Use ``ES_JAVA_OPTS="-Xms1g -Xmx1g" ./bin/elasticsearch -d`` to set the memory allotment on startup (`read more <https://www.elastic.co/guide/en/elasticsearch/guide/current/heap-sizing.html>`_). You can use the same command to give **more** memory to Elasticsearch in a production setting.

   2. Some users have reported getting this error right after starting Elasticsearch: ``org.elasticsearch.bootstrap.StartupException: java.lang.IllegalStateException: No match found``. Upgrading to 5.2.2 seems to fix this problem, as described in `this issue <https://github.com/elastic/elasticsearch/issues/23218>`_.

Connection Settings
===================

To connect Arches to Elasticsearch (once you have it running), make sure these two ``settings.py``
variables have been updated if necessary (defaults shown below assume that you have Elasticsearch running
locally on port 9200)::

    ELASTICSEARCH_HTTP_PORT = 9200
    ELASTICSEARCH_HOSTS = [{'host': 'localhost', 'port': ELASTICSEARCH_HTTP_PORT}]
    
If you are not running Elasticsearch locally, but on a remote server on a
non-standard port, these settings could look like::

    ELASTICSEARCH_HTTP_PORT = 9400
    ELASTICSEARCH_HOSTS = [{'host': 'my-es.domain.com', 'port': ELASTICSEARCH_HTTP_PORT}]

In this case, the my-es.domain.com server will need to allow connections via port 9400 from
your Arches instance IP address.
    
Elasticsearch Index Prefix Setting
==================================

In ``settings.py`` you'll find the variable ``ELASTICSEARCH_PREFIX``. By default it is the
name of your project, and this prefix is prepended to all of the Elasticsearch indices that
your project creates and uses. For example::

    ELASTICSEARCH_PREFIX = 'my_project'

will result in these indices in your Elasticsearch instance::

    my_project_resource
    my_project_resource_relations
    my_project_strings
    
This allows multiple projects to use the same Elasticsearch instance without sharing any data
(which can be very economical).

Reindexing the Database
=======================

You may need to reindex the entire database now and then. This can be helpful if a bulk load
failed halfway through, or if you need to point your database at a different Elasticsearch installation.
In the command line run::

    python manage.py es index_database

Be warned that this process can take a long time if you have a lot of resources in your database.
Also, if you are in ``DEBUG`` mode it can cause your server to run out of memory (see :ref:`reindex the database`).

If the ``es index_database`` operation doesn't solve your issue, you can try this series of commands::

    python manage.py es delete_indexes
    python manage.py es setup_indexes
    python manage.py es index_database

Using Multiple Nodes
====================

In production it's advisable to have multiple Elasticsearch instances working together as nodes of
a single cluster. To do this, you need to install a second Elasticsearch instance, and change the
``config/elasticsearch.yml`` file in each instance. Note that the cluster and node names can be whatever
you want, as long as the ``cluster.name`` is the same in both instances and the ``node.name`` is unique
to each one.

**Master (Original) Node Config**

.. code:: yaml

    http.port: 9200

    cluster.name: arches-app
    node.name: arches-app-node1

    node.master: true
    node.data: true

**Secondary Node Config**

.. code:: yaml

    http.port: 9201

    cluster.name: arches-app
    node.name: arches-app-node2

    node.master: false
    node.data: true

**Leave all other parameters untouched.**

You'll need to start/stop each of these instances individually, but you should always
have both running. When they are, the secondary node will automatically find the master
node and the indices will be replicated between the two.

Nothing about your project's ``settings.py`` should change; Arches need only connect
to the original Elasticsearch instance as before. However, you'll see now in the console output
that the cluster health will be ``[GREEN]`` when you have two nodes running (it's ``[YELLOW]`` 
if you only have one).

.. seealso::

    Here's some `background <http://chrissimpson.co.uk/elasticsearch-yellow-cluster-status-explained.html>`_
    and a `stack overflow question <https://stackoverflow.com/questions/35717790/how-to-add-a-new-node-to-my-elasticsearch-cluster>`_
    with instructions for adding a node.
